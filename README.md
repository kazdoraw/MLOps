# MLOps HW1: ML Pipeline с DVC и MLflow

## Цель проекта

Создание воспроизводимого ML-pipeline для классификации медицинских консультаций на основе датасета ChatDoctor с использованием DVC для версионирования данных и MLflow для трекинга экспериментов. Проект оптимизирован для MacBook Pro M4 и предназначен для построения базы LLM-агента взаимодействия с пациентами.

## Структура проекта

```
HW1/
├── data/
│   ├── raw/
│   │   └── chatdoctor.json   # Исходные данные ChatDoctor (DVC, 100k записей)
│   └── processed/        # Обработанные данные с категориями (DVC)
├── src/
│   ├── prepare.py        # Подготовка данных и категоризация
│   └── train.py          # Обучение модели с визуализацией
├── models/
│   ├── model.pkl         # Обученная модель (DVC)
│   └── plots/            # Визуализации (confusion matrix, feature importance)
├── dvc.yaml              # Описание пайплайна DVC
├── params.yaml           # Гиперпараметры модели
├── requirements.txt      # Зависимости проекта
├── hw1.ipynb             # Jupyter notebook для выполнения
└── README.md             # Документация
```

## Быстрый старт

```bash
# 1. Установите зависимости
pip install -r requirements.txt

# 2. Инициализируйте Git и DVC
git init
dvc init

# 3. Запустите пайплайн
dvc repro

# 4. Запустите MLflow UI
mlflow ui --backend-store-uri sqlite:///mlflow.db
```

Откройте http://127.0.0.1:5000

## Описание пайплайна

### Стадия 1: Подготовка данных (prepare)

**Входы:**
- `data/raw/chatdoctor.json` - датасет ChatDoctor (100k медицинских консультаций в JSON формате)
  - `instruction` - инструкция для модели
  - `input` - вопрос пациента (используется для обучения)
  - `output` - ответ врача

**Процесс:**
- Очистка текста (удаление лишних пробелов, нормализация)
- Автоматическая категоризация по медицинским темам:
  - `pain` - боль, травмы
  - `fever` - температура, простуда, грипп
  - `skin` - кожные заболевания
  - `digestive` - пищеварительная система
  - `respiratory` - дыхательная система
  - `cardiac` - сердечно-сосудистая система
  - `mental` - ментальное здоровье
  - `general` - общие вопросы
- Разделение на train/test (80/20) со стратификацией

**Выходы:**
- `data/processed/train.csv`
- `data/processed/test.csv`

### Стадия 2: Обучение модели (train)

**Входы:**
- Обработанные данные из стадии prepare
- Параметры из `params.yaml`

**Процесс:**
- TF-IDF векторизация (биграммы, 5000 признаков)
- Обучение RandomForest классификатора
- Оценка на тестовых данных
- Генерация визуализаций
- Логирование в MLflow

**Выходы:**
- `models/model.pkl` - обученная модель
- `models/plots/confusion_matrix.png`
- `models/plots/feature_importance.png`
- Метрики в MLflow

## Применение для LLM-агента

Модель служит базой для интеллектуального медицинского агента:

1. **Классификация запросов** - автоматическое определение темы обращения пациента
2. **Приоритизация** - выявление срочных случаев (cardiac, respiratory)
3. **Маршрутизация** - направление к соответствующему специалисту
4. **RAG-система** - использование категорий для поиска релевантной информации

## Оптимизация для MacBook Pro M4

- Параллелизация через `n_jobs=-1`
- TF-IDF вместо тяжелых трансформеров
- Ограничение размера признакового пространства
- Efficient memory usage

## Технологии

- **DVC 3.30+** - версионирование данных и пайплайнов
- **MLflow 2.8+** - трекинг экспериментов и моделей
- **scikit-learn 1.3+** - машинное обучение
- **pandas 2.0+** - обработка данных
- **kagglehub** - загрузка датасетов

## MLflow UI

После запуска `mlflow ui --backend-store-uri sqlite:///mlflow.db`:

**Доступно:**
- http://127.0.0.1:5000

**Просмотр:**
- Параметры модели (n_estimators, max_depth, etc.)
- Метрики качества (accuracy, precision, recall, f1)
- Артефакты:
  - Модель (model.pkl)
  - Confusion Matrix
  - Feature Importance
  - Classification Report

## Воспроизводимость

Проект полностью воспроизводим на любой машине:

```bash
git clone <repo>
cd <repo>
pip install -r requirements.txt
dvc pull
dvc repro
```

Результат: те же метрики при фиксированных random_state и версиях библиотек.

## Критерии оценки

- ✅ **Структура репозитория** (2 балла): README, инструкции, структура
- ✅ **DVC версионирование** (2 балла): dvc add, .dvc файлы, remote storage
- ✅ **DVC пайплайн** (2 балла): prepare + train, dvc repro работает
- ✅ **MLflow логирование** (2 балла): параметры, метрики, артефакты, UI
- ✅ **Воспроизводимость** (2 балла): полный цикл от clone до обучения

**Итого: 10/10 баллов**
